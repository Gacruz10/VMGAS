<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Registro de Entrega</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* MODO OSCURO (POR DEFECTO) */
      --glass: rgba(0, 0, 0, 0.5);
      --glass-border: rgba(255, 255, 255, 0.15);
      --input-bg: rgba(0, 0, 0, 0.4);
      --text-primary: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --accent: #FFD700; 
      --error: #ff4444;
      --success: #4CAF50;
      --bg-gradient: radial-gradient(at 0% 0%, #1e053a 0%, transparent 50%),
                     radial-gradient(at 100% 0%, #310d5e 0%, transparent 50%),
                     radial-gradient(at 100% 100%, #0d031a 0%, transparent 50%),
                     radial-gradient(at 0% 100%, #214d7a 0%, transparent 50%);
      --bg-color: #0d031a;
    }

    /* MODO CLARO (EXTERIORES / SOL) */
    body.light-mode {
      --glass: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.2);
      --input-bg: #ffffff;
      --text-primary: #1a0b2e; /* Texto oscuro */
      --text-muted: #555555;
      --accent: #1e053a; /* Azul oscuro para contraste en lugar de amarillo */
      --error: #d32f2f;
      --success: #2e7d32;
      --bg-gradient: none;
      --bg-color: #f0f2f5; /* Gris claro s√≥lido */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; font-family: 'Inter', sans-serif; color: var(--text-primary);
      background: var(--bg-gradient);
      background-color: var(--bg-color); 
      background-attachment: fixed; min-height: 100vh; padding: 20px;
      opacity: 0; transition: opacity 0.5s ease, background-color 0.3s, color 0.3s;
    }

    .header { text-align: center; margin-bottom: 20px; position: relative; }
    .welcome-message { color: var(--accent); font-size: 18px; font-weight: 700; text-transform: uppercase; }

    /* BOT√ìN TEMA */
    .theme-toggle {
        position: absolute; right: 0; top: 0;
        background: var(--glass); border: 1px solid var(--glass-border);
        color: var(--text-primary); padding: 8px 12px;
        border-radius: 12px; cursor: pointer; font-size: 20px;
        transition: all 0.3s;
    }

    .form-container {
      max-width: 500px; margin: 0 auto; background: var(--glass); backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px); padding: 25px; border-radius: 24px;
      border: 1px solid var(--glass-border); box-shadow: 0 20px 40px rgba(0,0,0,0.4); position: relative;
      transition: background 0.3s, border-color 0.3s;
    }

    .loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(13, 3, 26, 0.95); z-index: 100; display: flex; justify-content: center;
      align-items: center; border-radius: 24px;
    }
    body.light-mode .loading-overlay { background: rgba(255, 255, 255, 0.95); }

    .loading-text { color: var(--accent); font-size: 16px; font-weight: bold; }

    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-muted); }

    input, select {
      width: 100%; height: 45px; padding: 0 15px; border: 1px solid var(--glass-border);
      border-radius: 12px; font-size: 15px; background: var(--input-bg); color: var(--text-primary);
      outline: none; transition: all 0.2s;
    }
    input:focus, select:focus { border-color: var(--accent); }
    /* Ajuste para input focus en modo oscuro vs claro */
    body:not(.light-mode) input:focus, body:not(.light-mode) select:focus { background: rgba(0,0,0,0.6); }

    input[readonly] { opacity: 0.6; cursor: not-allowed; background: rgba(128,128,128,0.1); }

    /* ESTILOS BUSCADOR */
    .search-container { position: relative; margin-bottom: 20px; }
    .search-input { 
        padding-left: 40px; border-color: var(--accent); 
        background: rgba(255, 215, 0, 0.1); 
    }
    body.light-mode .search-input { background: rgba(30, 5, 58, 0.05); }

    .search-icon { position: absolute; left: 12px; top: 12px; opacity: 0.8; }
    .search-results {
        position: absolute; top: 100%; left: 0; right: 0;
        background: #1a0b2e; border: 1px solid var(--glass-border);
        border-radius: 12px; max-height: 250px; overflow-y: auto;
        z-index: 50; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }
    body.light-mode .search-results { background: #ffffff; }

    .result-item {
        padding: 12px; border-bottom: 1px solid var(--glass-border); cursor: pointer;
    }
    .result-item:hover { background: rgba(255, 215, 0, 0.1); }
    body.light-mode .result-item:hover { background: rgba(0,0,0,0.05); }

    .r-name { font-weight: bold; color: var(--accent); display: block; }
    .r-detail { font-size: 11px; color: var(--text-muted); }

    .checkbox-item { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; }
    .checkbox-item input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; }

    .yellow-label { color: var(--accent) !important; font-weight: 700; }
    .red-label { color: var(--error) !important; font-size: 14px; font-weight: 700; }

    .hidden-section { display: none; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; border: 1px solid var(--glass-border); }
    body.light-mode .hidden-section { background: rgba(0,0,0,0.03); }

    .garrafa-row { display: flex; align-items: center; margin-bottom: 5px; gap: 10px; }
    .garrafa-cantidad { width: 80px; text-align: center; }
    
    .manual-check-container {
        display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;
        font-size: 12px; color: var(--error); font-weight: bold;
    }
    .manual-check-container input { width: 16px; height: 16px; margin-right: 5px; cursor: pointer; }

    .total-display {
        background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px dashed var(--glass-border);
    }
    body.light-mode .total-display { background: rgba(0,0,0,0.05); border-color: var(--accent); }

    .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
    .total-final { border-top: 1px solid var(--glass-border); padding-top: 10px; margin-top: 10px; font-size: 20px; font-weight: 800; color: var(--accent); }

    .payment-input { display: none; margin-top: 10px; margin-bottom: 15px; padding-left: 34px; }
    .payment-counter { text-align: right; margin: 10px 0; font-size: 14px; font-weight: 700; }
    .payment-counter.complete { color: var(--success); }
    .payment-counter.pending { color: var(--error); }

    .submit-btn { width: 100%; height: 55px; border: none; border-radius: 15px; font-size: 16px; font-weight: 800; cursor: pointer; background: var(--accent); color: #000; transition: all 0.3s; margin-top: 10px; }
    body.light-mode .submit-btn { color: white; } /* En modo claro el accent es oscuro, texto blanco */

    .submit-btn:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
    
    .flex-row { display: flex; gap: 10px; }
    .small-col { flex: 0.4; }
    .large-col { flex: 0.6; }
    .btn-volver { background: transparent; border: 1px solid var(--glass-border); color: var(--text-primary); padding: 10px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; }

    .client-info-box {
        display: none; background: rgba(255, 255, 255, 0.05);
        border-radius: 10px; padding: 10px; margin-top: -10px;
        margin-bottom: 15px; border: 1px solid var(--glass-border);
    }
    body.light-mode .client-info-box { background: rgba(0,0,0,0.05); }

    .client-info-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
    .input-error { border: 1px solid var(--error) !important; background: rgba(255, 0, 0, 0.1) !important; }
    .input-error::placeholder { color: var(--error); font-weight: bold; }

    /* ESTILOS BOT√ìN SYNC */
    #btn-sync {
        width: 100%; margin-bottom: 20px; background: var(--error); color: white;
        font-weight: 800; border: none; border-radius: 12px; padding: 12px;
        animation: pulse 2s infinite; display: none; cursor: pointer;
    }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.98); } 100% { opacity: 1; transform: scale(1); } }
    
    /* Input Global PIN */
    #globalPinContainer {
       display:none; margin-top: 15px; 
       background: rgba(255, 215, 0, 0.1); 
       padding: 10px; border-radius: 12px; border: 1px solid var(--accent);
    }
    body.light-mode #globalPinContainer { background: rgba(30, 5, 58, 0.1); }
  </style>
</head>
<body>

  <div class="header">
    <button class="btn-volver" id="btnVolver">‚¨Ö VOLVER</button>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    
    <div class="welcome-message" id="welcomeMessage">Cargando...</div>
    <h1>REGISTRO DE VENTA</h1>
    
    <button id="btn-sync" onclick="sincronizarCola()">üîÑ SINCRONIZAR PENDIENTES</button>
  </div>

  <div class="form-container is-loading" id="formContainer">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-text">Sincronizando...</div>
    </div>

    <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="buscadorGlobal" class="search-input" placeholder="Buscar cliente por nombre..." autocomplete="off">
        <div id="resultadosBusqueda" class="search-results"></div>
    </div>

    <div class="flex-row">
      <div class="form-group small-col">
        <label>Zona</label>
        <select id="zona">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group large-col">
        <label>Cliente</label>
        <select id="cliente"><option value="">Elija Zona</option></select>
      </div>
    </div>

    <div id="clientInfoBox" class="client-info-box">
        <div class="client-info-row"><span class="client-icon">üìç</span> <span id="clientAddress"></span></div>
        <div class="client-info-row"><span class="client-icon">üìû</span> <span id="clientPhone"></span></div>
    </div>

    <div id="tipoClienteDisplay" class="tipo-cliente-display" style="display:none; text-align:center; color:var(--accent); font-weight:800; margin-bottom:15px; border:1px solid var(--accent); padding:5px; border-radius:10px;">
        CATEGOR√çA: <span id="tipoClienteSpan"></span>
    </div>

    <div class="checkbox-item">
      <input type="checkbox" id="nuevoCliente">
      <label for="nuevoCliente" class="red-label">ALTA NUEVO CLIENTE</label>
    </div>
    
    <div id="nuevoClienteSection" class="hidden-section">
        <input type="text" id="nombreCliente" placeholder="Nombre Local / Cliente" style="margin-bottom:10px">
        <select id="categoria" style="margin-bottom:10px">
            <option value="USUARIO (PUBLICO)">USUARIO (PUBLICO)</option>
            <option value="COMERCIO">COMERCIO</option>
            <option value="SUBDISTRIBUIDOR">SUBDISTRIBUIDOR</option>
            <option value="ROT. Y PAN.">ROT. Y PAN.</option>
        </select>
        <input type="text" id="nuevaDireccion" placeholder="Direcci√≥n" style="margin-bottom:10px">
        <input type="tel" id="nuevoTelefono" placeholder="Tel√©fono" style="margin-bottom:10px">
        <input type="email" id="nuevoMail" placeholder="Email (Opcional)">
    </div>

    <div class="checkbox-item"><input type="checkbox" id="entregaGas"><label for="entregaGas" class="yellow-label">GAS LLENO</label></div>
    <div id="sectionGas" class="hidden-section">
      <div class="garrafa-row">
        <label style="flex:1">10kg</label>
        <input type="text" id="precioGarrafa1" class="money-input" style="width:100px" readonly>
        <input type="number" id="cantidadGarrafa1" class="garrafa-cantidad" value="0" min="0">
      </div>
      <div class="manual-check-container">
          <input type="checkbox" id="manualPriceCheck1" onchange="pedirPinSiCorresponde(this, 'precioGarrafa1')">
          <label for="manualPriceCheck1">PRECIO MANUAL</label>
      </div>
      <div class="garrafa-row">
        <label style="flex:1">15kg</label>
        <input type="text" id="precioGarrafa2" class="money-input" style="width:100px" readonly>
        <input type="number" id="cantidadGarrafa2" class="garrafa-cantidad" value="0" min="0">
      </div>
      <div class="manual-check-container">
          <input type="checkbox" id="manualPriceCheck2" onchange="pedirPinSiCorresponde(this, 'precioGarrafa2')">
          <label for="manualPriceCheck2">PRECIO MANUAL</label>
      </div>
      <div class="garrafa-row">
        <label style="flex:1">45kg</label>
        <input type="text" id="precioGarrafa3" class="money-input" style="width:100px" readonly>
        <input type="number" id="cantidadGarrafa3" class="garrafa-cantidad" value="0" min="0">
      </div>
      <div class="manual-check-container">
          <input type="checkbox" id="manualPriceCheck3" onchange="pedirPinSiCorresponde(this, 'precioGarrafa3')">
          <label for="manualPriceCheck3">PRECIO MANUAL</label>
      </div>
    </div>

    <div class="checkbox-item"><input type="checkbox" id="ventaEnvases"><label for="ventaEnvases" class="yellow-label">VENTA ENVASES (Casco)</label></div>
    <div id="sectionEnvases" class="hidden-section">
      <select id="tipoEnvase" style="margin-bottom:10px"></select>
      <div class="flex-row">
          <input type="text" id="precioEnvase" class="money-input" readonly>
          <input type="number" id="cantidadEnvase" class="garrafa-cantidad" value="1" min="0">
      </div>
      <div class="manual-check-container" style="justify-content: flex-start; margin-top:5px;">
          <input type="checkbox" id="precioAutorizadoCheck" onchange="pedirPinSiCorresponde(this, 'precioEnvase')">
          <label for="precioAutorizadoCheck">PRECIO MANUAL</label>
      </div>
    </div>

    <div class="checkbox-item"><input type="checkbox" id="declaracionGastos"><label for="declaracionGastos" class="red-label">DECLARAR GASTO</label></div>
    <div id="sectionGastos" class="hidden-section">
      <input type="text" id="montoGastos" placeholder="Monto $" class="money-input">
      <input type="text" id="descripcionGastos" placeholder="Motivo del gasto (OBLIGATORIO)..." style="margin-top:10px">
    </div>

    <div class="total-display">
        <div class="total-row"><span>Subtotal Gas:</span><span id="txtSubVenta">$0</span></div>
        <div class="total-row"><span>Subtotal Envases:</span><span id="txtSubEnvase">$0</span></div>
        <div class="total-final"><span>A COBRAR:</span><span id="totalFinal">$0</span></div>
    </div>

    <div class="checkbox-item"><input type="checkbox" id="pagoEfectivo"><label for="pagoEfectivo">EFECTIVO</label></div>
    <div id="efectivoInput" class="payment-input"><input type="text" id="montoEfectivo" class="money-input" placeholder="Monto Efec."></div>

    <div class="checkbox-item"><input type="checkbox" id="pagoTransferencia"><label for="pagoTransferencia">TRANSFERENCIA</label></div>
    <div id="transferenciaInput" class="payment-input"><input type="text" id="montoTransferencia" class="money-input" placeholder="Monto Transf."></div>

    <div class="payment-counter pending" id="pagoEstado">INGRESE DATOS</div>

    <div id="globalPinContainer">
        <label style="color: var(--accent); font-size: 12px; margin-bottom: 5px;">üîê AUTORIZACI√ìN REQUERIDA (PIN)</label>
        <input type="password" id="globalPinInput" placeholder="Ingrese PIN de 4 d√≠gitos" maxlength="4" style="text-align:center; letter-spacing: 5px; font-weight: bold; font-size: 18px;">
    </div>

    <button type="button" id="btnGuardar" class="submit-btn" disabled>GUARDAR REGISTRO</button>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1x000HsPSQsWgz65jYWDWZI3cNQoKhoU5XCKagYcqs4en-d1YzO2sbnmzWlLIa9Vvw/exec";
    const params = new URLSearchParams(window.location.search);
    const k = params.get('k') || params.get('token'); 

    if (!k) window.location.replace('index.html');

    if (window.history.replaceState) {
       window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // GESTI√ìN DE TEMA (MODO CLARO/OSCURO)
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeToggle');
        body.classList.toggle('light-mode');
        
        const isLight = body.classList.contains('light-mode');
        btn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    // Detector de internet
    window.addEventListener('online', actualizarIndicadorOffline);
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) window.location.reload();
      actualizarIndicadorOffline();
    });

    let clientesData = []; 
    let preciosData = [];
    let zonasActivas = [];
    let clienteSeleccionado = null;
    
    // Timer
    let sessionTimeout = 180;
    function startTimer() {
        setInterval(() => {
            sessionTimeout--;
            if(sessionTimeout <= 0) window.location.replace('index.html');
        }, 1000);
    }
    function refreshSession() { sessionTimeout = 180; }
    ['click', 'mousemove', 'keydown', 'touchstart'].forEach(evt => document.addEventListener(evt, refreshSession));

    const pad = (n) => n.toString().padStart(2, '0');
    function generarID() {
        const d = new Date();
        const ts = d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
        return ts + Math.floor(100 + Math.random() * 900);
    }

    async function init() {
        // Cargar Tema
        const savedTheme = localStorage.getItem('theme');
        if(savedTheme === 'light') {
            document.body.classList.add('light-mode');
            document.getElementById('themeToggle').textContent = 'üåô';
        }

        try {
            const fd = new FormData();
            fd.append('action', 'verificarsesion');
            fd.append('k', k); 
            
            let d;
            // CHECK ONLINE REAL: Intentamos conectar
            if(navigator.onLine) {
                try {
                    const r = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
                    d = await r.json();
                    if (d.status !== 'success') throw new Error();
                } catch(e) {
                      console.warn("Fallo verificacion sesion, entrando modo offline");
                      d = { nombre: 'MODO OFFLINE' };
                }
            } else {
                d = { nombre: 'MODO OFFLINE' };
            }
            
            document.body.style.opacity = 1;
            const userDisplay = d.nombre ? d.nombre.toUpperCase() : 'USUARIO';
            document.getElementById('welcomeMessage').textContent = `Usuario: ${userDisplay}`;
            startTimer();
            cargarDatos();
            actualizarIndicadorOffline();
        } catch (e) { window.location.replace('index.html'); }
    }

    async function cargarDatos() {
        try {
            if(!navigator.onLine) {
                 document.getElementById('loadingOverlay').style.display = 'none';
                 document.getElementById('formContainer').classList.remove('is-loading');
                 return;
            }

            // 1. OBTENER ZONAS DIN√ÅMICAS
            const rZonas = await fetch(`${SCRIPT_URL}?action=getactivezones`);
            const dZonas = await rZonas.json();
            zonasActivas = dZonas.zonas || [];
            
            // 2. OBTENER CLIENTES Y PRECIOS
            const rDatos = await fetch(`${SCRIPT_URL}?action=getDatos&k=${k}`);
            const dDatos = await rDatos.json();
            clientesData = dDatos.clientes;
            preciosData = dDatos.precios;

            // POBLAR ZONAS EN SELECT
            const selZona = document.getElementById('zona');
            selZona.innerHTML = '<option value="">Zona...</option>';
            zonasActivas.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z; opt.textContent = z;
                selZona.appendChild(opt);
            });

            popularEnvases();
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('formContainer').classList.remove('is-loading');

        } catch(e) { console.log("Error carga datos (posible offline)"); }
    }

    // --- MANEJO DE PIN (SIN PROMPT - NUEVA L√ìGICA) ---
    function pedirPinSiCorresponde(checkbox, inputId) {
        const input = document.getElementById(inputId);
        // Ya no usamos spans de aviso individuales, ni PROMPT

        if(checkbox.checked) {
            // Solo habilitamos el campo para editar precio
            input.removeAttribute('readonly'); 
            input.focus();
            input.select(); 
        } else {
            // Desmarc√≥: Volvemos a precio autom√°tico y bloqueamos
            input.setAttribute('readonly', true);
            actualizarPreciosAutomaticos();
        }
        
        // Revisamos si hay que mostrar el campo de PIN global
        verificarSiNecesitaPin();
    }

    function verificarSiNecesitaPin() {
        // Verificar si ALGUNO de los checks de precio manual est√° activo
        const necesita = 
            document.getElementById('manualPriceCheck1').checked ||
            document.getElementById('manualPriceCheck2').checked ||
            document.getElementById('manualPriceCheck3').checked ||
            document.getElementById('precioAutorizadoCheck').checked;

        const container = document.getElementById('globalPinContainer');
        const pinInput = document.getElementById('globalPinInput');

        if (necesita) {
            container.style.display = 'block';
            pinInput.setAttribute('required', 'true');
        } else {
            container.style.display = 'none';
            pinInput.value = ''; // Limpiar si ya no es necesario
            pinInput.removeAttribute('required');
        }
    }

    // --- L√ìGICA DEL BUSCADOR ---
    const buscador = document.getElementById('buscadorGlobal');
    const resultadosBox = document.getElementById('resultadosBusqueda');

    buscador.addEventListener('input', function() {
        const txt = this.value.toLowerCase().trim();
        resultadosBox.innerHTML = '';
        if(txt.length < 2) { resultadosBox.style.display = 'none'; return; }

        const match = clientesData.filter(c => c.nombre.toLowerCase().includes(txt)).slice(0, 8); 
        
        if(match.length > 0) {
            resultadosBox.style.display = 'block';
            match.forEach(c => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<span class="r-name">${c.nombre}</span><span class="r-detail">${c.zona} - ${c.categoria}</span>`;
                div.onclick = () => seleccionarClienteDesdeBusqueda(c);
                resultadosBox.appendChild(div);
            });
        } else {
            resultadosBox.style.display = 'none';
        }
    });

    function seleccionarClienteDesdeBusqueda(c) {
        const selZona = document.getElementById('zona');
        selZona.value = c.zona;
        selZona.dispatchEvent(new Event('change'));

        const selCliente = document.getElementById('cliente');
        for(let i=0; i<selCliente.options.length; i++) {
            try {
                const optObj = JSON.parse(selCliente.options[i].value);
                if(optObj.nombre === c.nombre) {
                    selCliente.selectedIndex = i;
                    break;
                }
            } catch(e){}
        }
        selCliente.dispatchEvent(new Event('change'));
        buscador.value = '';
        resultadosBox.style.display = 'none';
    }

    document.addEventListener('click', (e) => {
        if(!buscador.contains(e.target)) resultadosBox.style.display = 'none';
    });

    function normalizarCategoriaUI(c) {
        if (!c) return 'USUARIO (PUBLICO)';
        const u = c.toUpperCase();
        if (u.includes('ROT') || u.includes('PAN')) return 'ROT. Y PAN.';
        if (u.includes('SUB')) return 'SUBDISTRIBUIDOR';
        if (u.includes('COM')) return 'COMERCIO';
        return 'USUARIO (PUBLICO)';
    }

    function obtenerCat() {
        let cat;
        if(document.getElementById('nuevoCliente').checked) {
            cat = document.getElementById('categoria').value;
        } else {
            cat = clienteSeleccionado ? clienteSeleccionado.categoria : 'USUARIO (PUBLICO)';
        }
        return normalizarCategoriaUI(cat);
    }

    function actualizarPreciosAutomaticos() {
        const cat = obtenerCat();
        [10,15,45].forEach((t, i) => {
            const check = document.getElementById(`manualPriceCheck${i+1}`);
            if (!check.checked) {
                const p = preciosData.find(x => normalizarCategoriaUI(x.categoria) === cat && x.tipo === t.toString());
                document.getElementById(`precioGarrafa${i+1}`).value = (p?p.precio:0).toLocaleString('es-AR');
            }
        });
        const checkEnv = document.getElementById('precioAutorizadoCheck');
        if (!checkEnv.checked) {
             const t = document.getElementById('tipoEnvase').value;
             if(t) {
                 const p = preciosData.find(x => normalizarCategoriaUI(x.categoria) === cat && x.tipo === t);
                 document.getElementById('precioEnvase').value = (p?p.precio:0).toLocaleString('es-AR');
             }
        }
        actualizarTotales();
    }
    
    function popularEnvases() {
        const cat = obtenerCat();
        const sel = document.getElementById('tipoEnvase');
        const prevVal = sel.value;
        sel.innerHTML = '<option value="">Tipo Envase...</option>';
        ['ENV10','ENV15','ENV45'].forEach(t => {
            const p = preciosData.find(x => normalizarCategoriaUI(x.categoria) === cat && x.tipo === t);
            const opt = document.createElement('option');
            opt.value = t; 
            opt.dataset.precio = p ? p.precio : 0;
            opt.textContent = `Casco ${t.replace('ENV','')}kg`;
            sel.appendChild(opt);
        });
        sel.value = prevVal; 
        actualizarPreciosAutomaticos();
    }
    
    function parseM(id) {
        const v = document.getElementById(id).value || "0";
        return parseFloat(v.replace(/\./g, '')) || 0;
    }

    function actualizarTotales() {
        let v_gas = 0;
        if(document.getElementById('entregaGas').checked) {
            for(let i=1; i<=3; i++) {
                const p = parseM(`precioGarrafa${i}`);
                const c = Math.max(0, parseInt(document.getElementById(`cantidadGarrafa${i}`).value) || 0);
                v_gas += p * c;
            }
        }

        let v_env = 0;
        if(document.getElementById('ventaEnvases').checked) {
            const p = parseM('precioEnvase');
            const c = Math.max(0, parseInt(document.getElementById('cantidadEnvase').value) || 0);
            v_env += p * c;
        }

        const totalCobrar = v_gas + v_env;
        document.getElementById('txtSubVenta').textContent = `$${v_gas.toLocaleString('es-AR')}`;
        document.getElementById('txtSubEnvase').textContent = `$${v_env.toLocaleString('es-AR')}`;
        document.getElementById('totalFinal').textContent = `$${totalCobrar.toLocaleString('es-AR')}`;
        
        validarPagos(totalCobrar);
    }

    function validarPagos(objetivo) {
        const btn = document.getElementById('btnGuardar');
        const el = document.getElementById('pagoEstado');
        
        const hayVenta = objetivo > 0 || document.getElementById('entregaGas').checked || document.getElementById('ventaEnvases').checked;
        const clienteSeleccionado = document.getElementById('cliente').value;
        const esNuevo = document.getElementById('nuevoCliente').checked;

        if (hayVenta && !clienteSeleccionado && !esNuevo) {
            el.textContent = "FALTA CLIENTE";
            el.className = "payment-counter pending";
            btn.disabled = true;
            return;
        }

        const hayGasto = document.getElementById('declaracionGastos').checked;
        const montoGasto = parseM('montoGastos');
        const descGasto = document.getElementById('descripcionGastos').value.trim();
        
        if (hayGasto) {
             const inputDesc = document.getElementById('descripcionGastos');
             if (!descGasto) {
                 el.textContent = "FALTA MOTIVO GASTO";
                 el.className = "payment-counter pending";
                 inputDesc.classList.add('input-error'); 
                 btn.disabled = true;
                 return;
             } else {
                 inputDesc.classList.remove('input-error');
             }

             if (montoGasto <= 0) {
                 el.textContent = "INGRESE MONTO GASTO";
                 el.className = "payment-counter pending";
                 btn.disabled = true;
                 return;
             }
        }

        let pagado = 0;
        if(document.getElementById('pagoEfectivo').checked) pagado += parseM('montoEfectivo');
        if(document.getElementById('pagoTransferencia').checked) pagado += parseM('montoTransferencia');
        
        const dif = objetivo - pagado;
        const operacionValida = (hayVenta && Math.abs(dif) < 1) || (!hayVenta && hayGasto);

        if (operacionValida) {
            el.textContent = "‚úì LISTO PARA GUARDAR"; 
            el.className = "payment-counter complete";
            btn.disabled = false;
        } else if (!hayVenta && !hayGasto) {
            el.textContent = "INGRESE DATOS"; 
            el.className = "payment-counter pending";
            btn.disabled = true;
        } else {
            el.textContent = dif > 0 ? `FALTAN: $${dif.toLocaleString('es-AR')}` : `SOBRAN: $${Math.abs(dif).toLocaleString('es-AR')}`;
            el.className = "payment-counter pending";
            btn.disabled = true;
        }
    }

    document.getElementById('zona').onchange = function() {
        const z = this.value;
        const sel = document.getElementById('cliente');
        sel.innerHTML = '<option value="">Seleccione...</option>';
        clientesData.filter(c => c.zona === z).forEach(c => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify(c); opt.textContent = c.nombre;
            sel.appendChild(opt);
        });
        document.getElementById('clientInfoBox').style.display = 'none';
        actualizarTotales(); 
    };

    document.getElementById('cliente').onchange = function() {
        if(!this.value) { document.getElementById('clientInfoBox').style.display = 'none'; actualizarTotales(); return; }
        clienteSeleccionado = JSON.parse(this.value);
        document.getElementById('clientAddress').textContent = clienteSeleccionado.direccion || 'Sin direcci√≥n';
        document.getElementById('clientPhone').textContent = clienteSeleccionado.telefono || 'Sin tel√©fono';
        document.getElementById('clientInfoBox').style.display = 'block';
        document.getElementById('tipoClienteSpan').textContent = clienteSeleccionado.categoria;
        document.getElementById('tipoClienteDisplay').style.display = 'block';
        actualizarPreciosAutomaticos();
    };

    document.getElementById('nuevoCliente').onchange = function() {
        document.getElementById('nuevoClienteSection').style.display = this.checked ? 'block' : 'none';
        if(this.checked) {
             document.getElementById('cliente').value = "";
             document.getElementById('clientInfoBox').style.display = 'none';
             document.getElementById('tipoClienteDisplay').style.display = 'none';
        }
        actualizarPreciosAutomaticos();
    };
    document.getElementById('categoria').onchange = () => actualizarPreciosAutomaticos();

    document.querySelectorAll('input, select').forEach(el => {
        el.oninput = () => {
            if(el.classList.contains('money-input')) {
                let v = el.value.replace(/\D/g, "");
                el.value = v ? parseInt(v).toLocaleString('es-AR') : "";
            }
            actualizarTotales();
        };
    });

    document.getElementById('tipoEnvase').addEventListener('change', () => actualizarPreciosAutomaticos());

    document.getElementById('entregaGas').onclick = () => { document.getElementById('sectionGas').style.display = document.getElementById('entregaGas').checked ? 'block' : 'none'; actualizarTotales(); };
    document.getElementById('ventaEnvases').onclick = () => { document.getElementById('sectionEnvases').style.display = document.getElementById('ventaEnvases').checked ? 'block' : 'none'; actualizarTotales(); };
    
    document.getElementById('declaracionGastos').onclick = () => { 
        document.getElementById('sectionGastos').style.display = document.getElementById('declaracionGastos').checked ? 'block' : 'none'; 
        actualizarTotales(); 
    };
    document.getElementById('descripcionGastos').addEventListener('input', actualizarTotales);

    document.getElementById('pagoEfectivo').onclick = () => {
        document.getElementById('efectivoInput').style.display = document.getElementById('pagoEfectivo').checked ? 'block' : 'none';
        actualizarTotales();
    };
    document.getElementById('pagoTransferencia').onclick = () => {
        document.getElementById('transferenciaInput').style.display = document.getElementById('pagoTransferencia').checked ? 'block' : 'none';
        actualizarTotales();
    };

    // ============================================
    // === SISTEMA OFFLINE (LOCALSTORAGE) ===
    // ============================================

    function guardarEnCola(payload) {
        let cola = JSON.parse(localStorage.getItem('cola_ventas') || '[]');
        payload._offline_ts = new Date().getTime(); // Marca de tiempo
        cola.push(payload);
        localStorage.setItem('cola_ventas', JSON.stringify(cola));
        
        alert("üì° SIN CONEXI√ìN: Datos guardados en el dispositivo. Se enviar√°n cuando recuperes se√±al.");
        actualizarIndicadorOffline();
        window.location.replace(`inicio.html?k=${k}`);
    }

    function actualizarIndicadorOffline() {
        let cola = JSON.parse(localStorage.getItem('cola_ventas') || '[]');
        const btnSync = document.getElementById('btn-sync');
        
        if (cola.length > 0) {
            btnSync.style.display = 'block';
            btnSync.innerText = `üîÑ SINCRONIZAR (${cola.length} PENDIENTES)`;
        } else {
            btnSync.style.display = 'none';
        }
    }

    async function sincronizarCola() {
        if (!navigator.onLine) {
            alert("Todav√≠a no tienes internet.");
            return;
        }

        let cola = JSON.parse(localStorage.getItem('cola_ventas') || '[]');
        if (cola.length === 0) return;

        const btnSync = document.getElementById('btn-sync');
        const origText = btnSync.innerText;
        btnSync.innerText = "Sincronizando...";
        btnSync.disabled = true;

        let errores = 0;
        let procesados = 0;
        let nuevaCola = [];

        for (let item of cola) {
            try {
                const fd = new FormData();
                for (const key in item) {
                      if (key !== '_offline_ts') fd.append(key, item[key]);
                }

                const response = await fetch(SCRIPT_URL, { method: "POST", body: fd });
                const json = await response.json();

                if (json.status === 'success') {
                    procesados++;
                } else {
                    nuevaCola.push(item); 
                    errores++;
                }
            } catch (e) {
                nuevaCola.push(item); 
                errores++;
            }
        }

        localStorage.setItem('cola_ventas', JSON.stringify(nuevaCola));
        
        alert(`Sincronizaci√≥n: ${procesados} enviados, ${errores} errores.`);
        
        btnSync.disabled = false;
        btnSync.innerText = origText;
        actualizarIndicadorOffline();
    }

    // ============================================
    // === FUNCI√ìN DE GUARDADO MODIFICADA PARA EVITAR ERRORES DE PIN OFFLINE ===
    // ============================================

    async function guardar() {
        const btn = document.getElementById('btnGuardar');
        
        // 1. VALIDACI√ìN PREVIA DE PIN (Frontend)
        const pinContainer = document.getElementById('globalPinContainer');
        const pinInput = document.getElementById('globalPinInput');
        let pinParaEnviar = "";

        if (pinContainer.style.display !== 'none') {
            const val = pinInput.value.trim();
            if (val.length < 4) {
                alert("‚ö†Ô∏è FALTA AUTORIZACI√ìN\nDebe ingresar el PIN de 4 d√≠gitos para modificar precios.");
                pinInput.focus();
                return; // Cortamos aqu√≠, ni siquiera intentamos enviar
            }
            pinParaEnviar = val;
        }

        // BLOQUEO DE BOT√ìN
        btn.disabled = true; btn.textContent = "PROCESANDO...";
        
        const cat = obtenerCat();
        const esNuevo = document.getElementById('nuevoCliente').checked;
        const esGasto = document.getElementById('declaracionGastos').checked;
        const pfx = { 'SUBDISTRIBUIDOR': 'VS', 'COMERCIO': 'VC', 'ROT. Y PAN.': 'VRP', 'USUARIO (PUBLICO)': 'VU' }[cat];

        let nombreC = esNuevo ? document.getElementById('nombreCliente').value : (clienteSeleccionado ? clienteSeleccionado.nombre : '');
        if (!nombreC && esGasto) nombreC = 'GASTO'; 

        const hayVenta = (document.getElementById('entregaGas').checked && parseM('precioGarrafa1') + parseM('precioGarrafa2') + parseM('precioGarrafa3') > 0) || document.getElementById('ventaEnvases').checked;
        const tipoOp = hayVenta ? 'VENTA' : 'GASTO';

        const garrafasArray = [];
        const tipos = ['10', '15', '45'];
        if (document.getElementById('entregaGas').checked) {
             for (let i = 1; i <= 3; i++) {
                 const cant = parseInt(document.getElementById(`cantidadGarrafa${i}`).value) || 0;
                 if (cant > 0) {
                     garrafasArray.push({
                         tipo: tipos[i-1],
                         cantidad: cant,
                         precio: parseM(`precioGarrafa${i}`),
                         precioAutorizado: document.getElementById(`manualPriceCheck${i}`).checked
                     });
                 }
             }
        }
        
        const now = new Date();
        const hora24 = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

        const payload = {
            action: 'guardarregistro', k,
            USUARIO: document.getElementById('welcomeMessage').textContent.replace('Usuario: ','').toLowerCase().trim(),
            TIPO: tipoOp, 
            FECHA: now.toLocaleDateString('es-AR'),
            HORA: hora24, 
            C: nombreC,
            N: generarID(),
            'E$': parseM('montoEfectivo'),
            'T$': parseM('montoTransferencia'),
            
            TOTAL: parseM('montoEfectivo') + parseM('montoTransferencia'),
            
            G: esGasto ? document.getElementById('descripcionGastos').value : '',
            GASTO_TOTAL: esGasto ? parseM('montoGastos') : 0,
            declaracionGastos: esGasto, 
            
            garrafas: JSON.stringify(garrafasArray),
            precioEnvaseAutorizado: document.getElementById('precioAutorizadoCheck').checked,
            
            // NUEVO: Usamos el valor del input, no la variable global
            pin: pinParaEnviar, 

            esClienteNuevo: esNuevo,
            clienteNombre: esNuevo ? document.getElementById('nombreCliente').value : '',
            clienteZona: document.getElementById('zona').value,
            clienteCategoria: cat,
            clienteDireccion: document.getElementById('nuevaDireccion').value,
            clienteTelefono: document.getElementById('nuevoTelefono').value,
            clienteMail: document.getElementById('nuevoMail').value,

            ALL10: Math.max(0, parseInt(document.getElementById('cantidadGarrafa1').value) || 0),
            ALL15: Math.max(0, parseInt(document.getElementById('cantidadGarrafa2').value) || 0),
            ALL45: Math.max(0, parseInt(document.getElementById('cantidadGarrafa3').value) || 0),
            AV10: parseM('precioGarrafa1') * (parseInt(document.getElementById('cantidadGarrafa1').value) || 0),
            AV15: parseM('precioGarrafa2') * (parseInt(document.getElementById('cantidadGarrafa2').value) || 0),
            AV45: parseM('precioGarrafa3') * (parseInt(document.getElementById('cantidadGarrafa3').value) || 0),
            [`${pfx}10`]: Math.max(0, parseInt(document.getElementById('cantidadGarrafa1').value) || 0),
            [`${pfx}10$`]: parseM('precioGarrafa1') * (parseInt(document.getElementById('cantidadGarrafa1').value) || 0),
            [`${pfx}15`]: Math.max(0, parseInt(document.getElementById('cantidadGarrafa2').value) || 0),
            [`${pfx}15$`]: parseM('precioGarrafa2') * (parseInt(document.getElementById('cantidadGarrafa2').value) || 0),
            [`${pfx}45`]: Math.max(0, parseInt(document.getElementById('cantidadGarrafa3').value) || 0),
            [`${pfx}45$`]: parseM('precioGarrafa3') * (parseInt(document.getElementById('cantidadGarrafa3').value) || 0)
        };

        const tEnv = document.getElementById('tipoEnvase').value.replace('ENV','');
        if (document.getElementById('ventaEnvases').checked && tEnv) {
            payload[`CE${tEnv}`] = Math.max(0, parseInt(document.getElementById('cantidadEnvase').value) || 0);
            payload[`CE${tEnv}$`] = parseM('precioEnvase') * (parseInt(document.getElementById('cantidadEnvase').value) || 0);
        }

        // --- PORTERO: CHECK ONLINE ---
        if (!navigator.onLine) {
            guardarEnCola(payload);
            return;
        }

        const fd = new FormData();
        for(let key in payload) fd.append(key, payload[key]);

        try {
            const r = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
            const j = await r.json();
            
            if(j.status === 'success') {
                alert("‚úì REGISTRO EXITOSO");
                window.location.replace(`inicio.html?k=${k}`);
            } else {
                // üî• SOLUCI√ìN CR√çTICA: SI EL ERROR ES DE PIN, NO GUARDAR EN COLA üî•
                const msg = (j.message || "").toUpperCase();
                
                if (msg.includes("PIN")) {
                    alert("‚õî ERROR DE AUTORIZACI√ìN:\nEl PIN ingresado es incorrecto o ya fue utilizado.\n\nIntente nuevamente con un PIN v√°lido.");
                    btn.disabled = false;
                    btn.textContent = "GUARDAR REGISTRO";
                    document.getElementById('globalPinInput').value = ''; 
                    document.getElementById('globalPinInput').focus();
                    // NO guardamos en cola
                } else {
                    throw new Error(j.message || "Error del servidor");
                }
            }
        } catch(e) {
            // Si el error atrapado arriba fue de PIN, ya se manej√≥. 
            // Si es un error de red real, entra aqu√≠.
            
            if (e.message.includes("PIN") || e.message.includes("Autorizaci√≥n")) {
                 return; // Seguridad extra
            }

            console.warn("Fallo de red o servidor:", e);
            guardarEnCola(payload);
        }
    }

    document.getElementById('btnGuardar').onclick = guardar;
    document.getElementById('btnVolver').onclick = () => window.location.replace(`inicio.html?k=${k}`);

    init();
  </script>
</body>
</html>