<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Menú Principal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --glass: rgba(0, 0, 0, 0.5);
    --glass-hover: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.15);
    --text-primary: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.6);
    --accent: #FFD700; 
    --badge-bg: #ff375f;
    --badge-text: #ffffff;
    /* Estilos PIN */
    --pin-bg: rgba(255, 215, 0, 0.15); 
    --pin-border: rgba(255, 215, 0, 0.4);
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: radial-gradient(at 0% 0%, #1e053a 0%, transparent 50%),
                radial-gradient(at 100% 0%, #310d5e 0%, transparent 50%),
                radial-gradient(at 100% 100%, #0d031a 0%, transparent 50%),
                radial-gradient(at 0% 100%, #214d7a 0%, transparent 50%);
    background-color: #0d031a;
    background-attachment: fixed;
    color: var(--text-primary);
    display: flex;
    justify-content: center;
    opacity: 0; 
    transition: opacity 0.5s ease;
  }

  .wrap {
    width: 100%;
    max-width: 1000px; 
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
  }

  /* Header Original */
  header { 
    padding: 30px 20px 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
  }
  
  .header-info { text-align: left; }
  .header-info h1 { margin: 0 0 8px; font-weight: 800; font-size: clamp(24px, 6vw, 32px); text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
  .header-info .hello { font-size: 12px; color: var(--accent); font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

  /* CAJITA DEL PIN (Arriba a la derecha) */
  .pin-display {
    display: none; /* Se activa con JS */
    background: var(--pin-bg);
    border: 1px solid var(--pin-border);
    color: var(--accent);
    padding: 8px 14px;
    border-radius: 12px;
    font-family: monospace;
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 3px;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
    transition: transform 0.1s, background 0.3s;
    text-align: center;
  }
  .pin-display:active { transform: scale(0.95); background: rgba(255,215,0,0.3); }

  .loader { text-align: center; font-size: 14px; color: var(--text-muted); margin-top: 50px; }

  .grid {
    padding: 10px 20px 40px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 20px; 
    width: 100%;
  }

  /* Tarjeta interactiva */
  .tile {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-decoration: none;
    color: var(--text-primary);
    background: var(--glass);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    height: 110px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    cursor: pointer;
    padding: 10px;
    overflow: visible; 
    transition: transform 0.2s ease, border-color 0.3s ease;
  }

  .tile::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: inherit; 
    background: radial-gradient(
        250px circle at var(--x, 50%) var(--y, 50%), 
        rgba(255, 255, 255, 0.15), 
        transparent 40%
    );
    opacity: 0; 
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 1;
  }

  .tile:hover::before { opacity: 1; }
  .tile:hover { border-color: rgba(255,255,255,0.4); transform: translateY(-2px); }
  .tile:active { transform: scale(0.96); }

  .tile .title { 
      font-weight: 600; font-size: 14px; line-height: 1.2; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
      position: relative; z-index: 2; 
  }

  .tile.finance { border-color: rgba(50, 205, 50, 0.3); } 
  .tile.audit { border-color: rgba(138, 43, 226, 0.3); }    

  .badge {
    position: absolute; top: -8px; right: -8px;
    background: var(--badge-bg); color: var(--badge-text);
    border: 2px solid rgba(255,255,255,0.2);
    font-weight: 800; font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    min-width: 28px; height: 28px; padding: 0 6px;
    border-radius: 99px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    z-index: 100;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap; 
  }
  @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-info">
        <h1>Menú Principal</h1>
        <p class="hello" id="hello">CARGANDO...</p>
      </div>
      
      <div id="pinBox" class="pin-display" onclick="revelarPin()" title="Tocar para ver PIN">****</div>
    </header>

    <div id="loader" class="loader">Validando acceso seguro...</div>

    <main class="grid" id="mainGrid" style="display:none">
      <a class="tile" id="tileFormulario" onclick="navegar('index4.html')" style="display:none"><span class="title">Formulario<br>de Venta</span></a>
      <a class="tile" id="tileClientes"   onclick="navegar('clientes.html')" style="display:none"><span class="title">Clientes</span></a>
      <a class="tile" id="tilePrecios"    onclick="navegar('precios.html')"  style="display:none"><span class="title">Precios</span></a>
      <a class="tile" id="tileUsuarios"   onclick="navegar('usuarios.html')" style="display:none"><span class="title">Usuarios</span></a>
      <a class="tile" id="tileAlarmas"    onclick="navegar('alarmas.html')"  style="display:none"><span class="title">Alarmas</span>
        <span class="badge" id="alarmBadge" style="display:none"></span></a>
      
      <a class="tile" id="tileTablero"    onclick="navegar('tablero.html')" style="display:none"><span class="title">Tablero</span></a>
      <a class="tile" id="tileStock"      onclick="navegar('controlstock.html')" style="display:none"><span class="title">Control<br>Stock</span></a>
      <a class="tile" id="tileCarga"      onclick="navegar('controlcarga.html')" style="display:none"><span class="title">Control<br>Carga</span></a>
      <a class="tile finance" id="tileFinanzas"   onclick="navegar('arqueo.html')" style="display:none"><span class="title">Arqueos</span></a>
      <a class="tile audit" id="tileConFinanzas" onclick="navegar('controlfinanzas.html')" style="display:none"><span class="title">Control<br>Finanzas</span></a>

      <a class="tile" onclick="logout()" style="border-color: rgba(255,55,95,0.3);"><span class="title" style="color:#ff375f">Cerrar Sesión</span></a>
    </main>
  </div>

<script>
// ================= CONFIGURACIÓN =================
const API = "https://script.google.com/macros/s/AKfycbzi1x000HsPSQsWgz65jYWDWZI3cNQoKhoU5XCKagYcqs4en-d1YzO2sbnmzWlLIa9Vvw/exec";
const TIMEOUT_SESION = 300000; // 5 minutos

// ================= SEGURIDAD DE ARRANQUE =================
const params = new URLSearchParams(window.location.search);
const k = params.get('k') || params.get('token');

if (!k) expulsar();

if (window.history.replaceState) {
    window.history.replaceState({}, document.title, window.location.pathname);
}
window.addEventListener('pageshow', function(event) {
  if (event.persisted) window.location.reload();
});

// ================= LÓGICA PRINCIPAL =================
let pinReal = null;

async function iniciarSesion() {
    try {
        const fd = new FormData();
        fd.append('action', 'verificarsesion');
        fd.append('k', k); 

        const r = await fetch(API, { method: 'POST', body: fd });
        const data = await r.json();

        if (data.status === 'success') {
            document.body.style.opacity = 1; 
            renderizarInterfaz(data.nombre, data.perms);
            
            // ---> BUSCAMOS EL PIN (Llamada extra) <---
            buscarPin();
            
        } else {
            throw new Error();
        }
    } catch (e) {
        expulsar();
    }
}

async function buscarPin() {
    try {
        // Asegúrate de haber corregido el 'case usuarioinfo' en tu script de Google
        const res = await fetch(`${API}?action=usuarioinfo&k=${k}`);
        const d = await res.json();
        
        if (d.status === 'success' && d.pin_dinamico) {
            pinReal = d.pin_dinamico;
            document.getElementById('pinBox').style.display = 'block';
        }
    } catch(e) { console.log("No se pudo obtener PIN"); }
}

function revelarPin() {
    const box = document.getElementById('pinBox');
    if (!pinReal) return;

    if (box.textContent.includes('*')) {
        box.textContent = pinReal;
        box.style.borderColor = '#ffffff';
        box.style.background = 'rgba(255, 215, 0, 0.3)';
        
        setTimeout(() => {
            box.textContent = '****';
            box.style.borderColor = 'var(--pin-border)';
            box.style.background = 'var(--pin-bg)';
        }, 5000);
    } else {
        box.textContent = '****';
        box.style.borderColor = 'var(--pin-border)';
        box.style.background = 'var(--pin-bg)';
    }
}

function renderizarInterfaz(nombre, perms) {
    document.getElementById('loader').style.display = 'none';
    const grid = document.getElementById('mainGrid');
    grid.style.display = 'grid'; 

    const h = new Date().getHours();
    const tramo = h < 12 ? 'BUENOS DÍAS' : (h < 19 ? 'BUENAS TARDES' : 'BUENAS NOCHES');
    document.getElementById('hello').textContent = `${tramo} ${nombre ? nombre.toUpperCase() : 'USUARIO'}`;

    const p = perms || {};
    const show = (id, condition) => {
        const el = document.getElementById(id);
        if (el) el.style.display = condition ? 'flex' : 'none';
    };

    show('tileFormulario',  p.formulario);
    show('tileClientes',    p.clientes);
    show('tilePrecios',     p.precios);
    show('tileUsuarios',    p.usuarios);
    show('tileAlarmas',     p.alarmas);
    show('tileTablero',     p.tablero);
    show('tileStock',       p.stock);
    show('tileCarga',       p.carga);
    show('tileFinanzas',    p.finanzas);
    show('tileConFinanzas', p.confinanzas);

    initHoverEffects();

    if (p.alarmas) loadAlarmBadge();
}

function initHoverEffects() {
    const tiles = document.querySelectorAll('.tile');
    if (window.matchMedia("(hover: hover)").matches) {
        tiles.forEach(tile => {
            tile.addEventListener('mousemove', (e) => {
                const rect = tile.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                tile.style.setProperty('--x', `${x}px`);
                tile.style.setProperty('--y', `${y}px`);
            });
        });
    }
}

function navegar(pagina) {
    if(!k) return;
    window.location.replace(`${pagina}?k=${k}`);
}

function expulsar() {
    sessionStorage.clear();
    window.location.replace('index.html');
}

function logout() { expulsar(); }

let t;
function resetTimer() {
    clearTimeout(t);
    t = setTimeout(expulsar, TIMEOUT_SESION);
}
['load','mousemove','mousedown','touchstart','click','keydown'].forEach(evt => 
    window.addEventListener(evt, resetTimer)
);

async function loadAlarmBadge(){
  try{
    const url = `${API}?action=alarmascount&_=${Date.now()}`;
    const r = await fetch(url);
    const j = await r.json();
    const n = Number(j?.pendientes || 0);
    const badge = document.getElementById('alarmBadge');
    if (n > 0){
      badge.textContent = n > 99 ? '99+' : String(n);
      badge.style.display = 'flex'; 
    }
  }catch(e){}
}

iniciarSesion();
</script>
</body>
</html>