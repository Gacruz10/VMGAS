<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<title>Control de Finanzas</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
  :root {
    --bg-dark: #050510;
    --accent: #FFD700; 
    --accent-edit: #ff9100; /* Naranja para edici√≥n */
    --accent-glow: rgba(255, 215, 0, 0.3);
    --text-main: #ffffff;
    --text-sec: #a0a0b0;
    --success: #056e03;
    --danger: #ff4757;
    --glass-border: rgba(255, 255, 255, 0.08);
    --card-gradient: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
  }

  /* ESTILOS DE MODO EDICI√ìN */
  body.edit-mode { --accent: var(--accent-edit); }
  body.edit-mode .fab { background: var(--accent-edit); transform: rotate(45deg); }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0; 
    font-family: 'Outfit', sans-serif;
    color: var(--text-main);
    background-color: var(--bg-dark);
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(255, 215, 0, 0.05) 0%, transparent 40%);
    background-attachment: fixed;
    min-height: 100vh;
    font-size: 13px;
    padding-bottom: 90px;
    opacity: 0; transition: opacity 0.6s ease;
  }

  /* --- HEADER --- */
  .fixed-header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(5, 5, 16, 0.95);
      backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--glass-border);
      padding: 8px 15px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.3);
  }

  .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; max-width: 1000px; margin-inline: auto; }
  
  .page-title { 
      font-size: 1rem; 
      background: linear-gradient(to right, #fff, var(--accent)); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin: 0; 
  }

  .btn-action {
    background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-sec);
    padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-size: 11px; font-weight: 600;
    display: flex; align-items: center; gap: 4px;
  }
  .btn-action:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: var(--text-sec); }
  
  .export-wrapper { position: relative; }
  .btn-export {
    background: rgba(255, 215, 0, 0.1); border: 1px solid var(--accent); color: var(--accent);
    padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 11px;
  }
  .btn-export:hover { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent-glow); }
  
  .dropdown-menu {
      display: none; position: absolute; right: 0; top: 110%;
      background: #151525; border: 1px solid var(--glass-border);
      border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000; min-width: 160px; overflow: hidden;
  }
  .dropdown-menu.show { display: block; }
  .dropdown-item { padding: 10px 12px; color: var(--text-sec); cursor: pointer; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .dropdown-item:hover { background: rgba(255, 215, 0, 0.1); color: var(--accent); }
  
  /* FILTERS */
  .filter-panel {
      display: flex; gap: 8px; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.02); padding: 4px; border-radius: 10px;
      border: 1px solid var(--glass-border); margin-bottom: 8px;
      max-width: 500px; margin-inline: auto; height: 32px;
  }
  .date-group { position: relative; flex: 1; }
  .date-group input {
    width: 100%; background: transparent; border: none;
    color: white; padding: 4px 4px 4px 24px; font-family: inherit; font-size: 12px; 
    cursor: pointer; font-weight: 500; height: 100%;
  }
  .date-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: var(--accent); font-size: 10px; }
  .btn-load {
      background: var(--accent); color: #000; border: none; padding: 0 15px; height: 24px;
      border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px;
  }

  /* DASHBOARD */
  .dashboard { 
      display: flex; gap: 8px; justify-content: center; 
      margin-bottom: 8px; flex-wrap: wrap; 
      max-width: 800px; margin-inline: auto;
  }
  .card {
      flex: 1; min-width: 120px;
      background: var(--card-gradient);
      border: 1px solid var(--glass-border);
      padding: 6px 10px; border-radius: 10px;
      text-align: center; position: relative; overflow: hidden;
  }
  .card label { font-size: 9px; color: var(--text-sec); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 2px; font-weight: 600; }
  .card .value { font-size: 1.1em; font-weight: 700; color: #fff; }
  .card.active-selection { border-color: var(--accent); background: rgba(255, 215, 0, 0.05); }
  .pos { color: var(--success) !important; }
  .neg { color: var(--danger) !important; }

  /* VIEW CONTROLS */
  .view-controls { 
      display: flex; gap: 2px; justify-content: center; 
      background: rgba(0,0,0,0.3); padding: 2px; border-radius: 8px; 
      width: fit-content; margin: 0 auto; 
      border: 1px solid var(--glass-border); 
  }
  .btn-view { 
      background: transparent; border: none; color: var(--text-sec); 
      padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; 
  }
  .btn-view.active { background: rgba(255,255,255,0.1); color: #fff; }

  /* --- TREE VIEW ESTILIZADO --- */
  .scroll-content { padding: 15px; max-width: 1000px; margin: 0 auto; }
  
  /* NIVEL 1 */
  details.l1-details {
      background: #000000; 
      border: 1px solid var(--glass-border);
      border-right: 4px solid var(--accent); 
      border-radius: 8px;
      margin-bottom: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      overflow: hidden;
      transition: border-color 0.3s;
  }
  details.l1-details > summary { 
      padding: 12px 15px; 
      font-size: 14px; 
      color: var(--accent); 
      display: flex; justify-content: space-between; align-items: center; 
  }
  .l1-name { font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #fff; }

  /* NIVEL 2 */
  .l2-container { padding: 0 0 0 0; }
  
  details.l2-details { 
      background: #1a1a1a; 
      border-top: 1px solid rgba(255,255,255,0.1); 
      border-right: 4px solid #444; 
      margin: 0;
      border-radius: 0;
  }
  details.l2-details > summary { 
      padding: 10px 15px 10px 30px; 
      font-size: 13px; 
      color: #fff;
      display: flex; justify-content: space-between; align-items: center;
  }
  .l2-name { color: #fff; font-weight: 600; }

  /* NIVEL 3 (DETALLES) */
  .table-responsive { background: #e0e0e0; }
  table { width: 100%; border-collapse: collapse; }
  tr { border-bottom: 1px solid #ccc; cursor: pointer; } 
  tr:last-child { border-bottom: none; }
  
  td { padding: 8px 15px; color: #000; font-size: 12px; font-weight: 500; }
  .col-desc { color: #333; }
  .col-monto { font-weight: 700; font-family: monospace; color: #000; }
  
  /* Checkboxes */
  .table-responsive input[type="checkbox"] { border-color: #555; }
  .table-responsive input[type="checkbox"]:checked::after { color: #000; }

  /* FAB */
  .fab { width: 45px; height: 45px; font-size: 24px; bottom: 20px; right: 20px; background: var(--accent); color: #000; border-radius: 50%; display: grid; place-items: center; position: fixed; box-shadow: 0 4px 15px var(--accent-glow); cursor: pointer; z-index: 200; transition: 0.3s; }
  
  /* MODAL DARK GLASS */
  #modal, #pinModal { 
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px); 
      background: rgba(0,0,0,0.6); 
      display: none; 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      z-index: 300; 
      align-items: center; justify-content: center;
  }
  .modal-content { 
      background: rgba(10, 10, 20, 0.9); 
      border: 1px solid rgba(255,255,255,0.1); 
      border-radius: 20px; 
      padding: 25px; 
      width: 90%; max-width: 380px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      text-align: center;
      border-top: 4px solid var(--accent);
  }
  .form-control { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: white; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 10px; }
  .form-control:focus { border-color: var(--accent); }
  
  .btn-save { width: 100%; background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 800; cursor: pointer; margin-top: 5px; transition: 0.3s; }
  .btn-save:hover { box-shadow: 0 0 15px var(--accent-glow); }
  .btn-cancel { width: 100%; background: transparent; border: 1px solid var(--glass-border); color: #fff; padding: 10px; margin-top: 10px; cursor: pointer; border-radius: 8px; }
  .btn-delete { width: 100%; background: rgba(255, 71, 87, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 10px; margin-top: 15px; cursor: pointer; border-radius: 8px; font-weight: 700; display: none; }

  /* Pin Input */
  .pin-wrapper { display: none; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; animation: slideDown 0.3s; }
  @keyframes slideDown { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }

  /* Auditor√≠a Visual */
  .audit-diff { font-size: 11px; margin-top: -5px; margin-bottom: 10px; color: var(--text-sec); display: none; }

</style>
</head>
<body>

  <div class="fixed-header">
    <div class="header-top">
       <button class="btn-action" id="btnVolver">‚ùÆ Volver</button>
       <h2 class="page-title">Control Finanzas</h2>
       
       <div style="display:flex; gap:10px">
           <button class="btn-action" onclick="openPinModal()">üîë</button>
           
           <div class="export-wrapper">
               <button class="btn-export" onclick="toggleExportMenu()">Exportar ‚ñº</button>
               <div id="export-menu" class="dropdown-menu">
                   <div class="dropdown-item" onclick="exportarPDF('jerarquico')">üìä Reporte Jer√°rquico</div>
                   <div class="dropdown-item" onclick="exportarPDF('simple')">üìë Reporte Simplificado</div>
               </div>
           </div>
       </div>
    </div>

      <div class="filter-panel">
          <div class="date-group"><span class="date-icon">üìÖ</span><input type="text" id="filter-start" placeholder="Desde"></div>
          <div style="color:var(--text-sec); font-size:10px">‚ûú</div>
          <div class="date-group"><span class="date-icon">üìÖ</span><input type="text" id="filter-end" placeholder="Hasta"></div>
          <button class="btn-load" onclick="cargarDatos()">IR</button>
      </div>

      <div class="dashboard" id="dashboard-panel">
          <div class="card"><label id="lbl-in">INGRESOS</label><div class="value pos" id="dash-in">...</div></div>
          <div class="card"><label id="lbl-out">GASTOS</label><div class="value neg" id="dash-out">...</div></div>
          <div class="card"><label id="lbl-total">BALANCE</label><div class="value" id="dash-total">...</div></div>
      </div>

      <div class="view-controls">
          <button class="btn-view" onclick="setTreeView('L1')">Cuentas</button>
          <button class="btn-view" onclick="setTreeView('L2')">Subcuentas</button>
          <button class="btn-view" onclick="setTreeView('ALL')">Detalle</button>
      </div>
  </div>

  <div class="scroll-content">
      <div id="tree-root" class="tree-container">
          <div style="padding:40px; text-align:center; color:var(--text-sec); font-size:12px;">
              <div style="margin-bottom:5px; font-size:16px;">‚ö°</div>Cargando...
          </div>
      </div>
  </div>

  <button class="fab" onclick="openModal('create')">+</button>

  <div id="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="color:var(--accent); text-align:center; margin:0 0 15px 0; font-size:16px;">Nueva Transacci√≥n</h3>
      <form id="expenseForm">
        <input type="hidden" id="edit-id"> 
        <input type="hidden" id="orig-amount">
        
        <label style="color:var(--text-sec); font-size:11px; display:block; text-align:left;">Fecha</label>
        <input type="text" class="form-control" id="modal-fecha" required>
        
        <label style="color:var(--text-sec); font-size:11px; display:block; text-align:left;">Rubro (Nivel 1)</label>
        <input list="list_l1" class="form-control" id="input_l1" placeholder="Ej: Operativo" onchange="updateDatalistL2()" required autocomplete="off"><datalist id="list_l1"></datalist>
        
        <label style="color:var(--text-sec); font-size:11px; display:block; text-align:left;">Sub-rubro (Nivel 2)</label>
        <input list="list_l2" class="form-control" id="input_l2" placeholder="Ej: Combustible" required autocomplete="off"><datalist id="list_l2"></datalist>
        
        <label style="color:var(--text-sec); font-size:11px; display:block; text-align:left;">Detalle</label>
        <input type="text" class="form-control" id="l3" placeholder="Descripci√≥n" required>
        
        <label style="color:var(--text-sec); font-size:11px; display:block; text-align:left;">Monto (Negativo = Gasto)</label>
        <input type="number" step="0.01" class="form-control" id="monto" placeholder="-1500" required oninput="checkDiff()">
        <div id="audit-msg" class="audit-diff"></div>

        <button type="button" class="btn-save" id="btn-main" onclick="handleMainAction()">GUARDAR</button>
        
        <div id="pin-area" class="pin-wrapper">
             <label style="color:var(--accent-edit); font-size:11px; font-weight:bold;">üîí PIN DE AUTORIZACI√ìN</label>
             <input type="password" id="auth-pin" class="form-control" style="text-align:center; letter-spacing:5px;" placeholder="****" maxlength="4">
             <button type="button" class="btn-save" style="background:var(--accent-edit); color:white;" onclick="confirmEdit()">CONFIRMAR CAMBIO</button>
        </div>

        <button type="button" class="btn-delete" id="btn-del" onclick="reqDelete()">üóë ELIMINAR REGISTRO</button>
        <button type="button" class="btn-cancel" onclick="closeModal()">CANCELAR</button>
      </form>
    </div>
  </div>

  <div id="pinModal">
      <div class="modal-content" style="border-top-color: #fff;">
          <h3 style="color:#fff; margin-bottom:15px;">Cambio de PIN Maestro</h3>
          <input type="password" id="old-pin" class="form-control" placeholder="PIN Actual" style="text-align:center">
          <input type="password" id="new-pin" class="form-control" placeholder="Nuevo PIN (4 d√≠gitos)" maxlength="4" style="text-align:center">
          <button type="button" class="btn-save" style="background:#fff; color:#000;" onclick="submitPinChange()">ACTUALIZAR LLAVE</button>
          <button type="button" class="btn-cancel" onclick="document.getElementById('pinModal').style.display='none'">CANCELAR</button>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzi1x000HsPSQsWgz65jYWDWZI3cNQoKhoU5XCKagYcqs4en-d1YzO2sbnmzWlLIa9Vvw/exec"; 
    const TIMEOUT_SESION = 180000;
    const params = new URLSearchParams(window.location.search);
    const k = params.get('k') || params.get('token');
    if (!k) window.location.replace('index.html');
    if (window.history.replaceState) window.history.replaceState({}, document.title, window.location.pathname);

    let tIdle;
    function resetTimer() { clearTimeout(tIdle); tIdle = setTimeout(() => window.location.replace('index.html'), TIMEOUT_SESION); }
    ['click','mousemove','keydown','touchstart'].forEach(e => document.addEventListener(e, resetTimer));
    resetTimer();

    var globalData = {};
    var currentSummary = {}; 
    var currentEditMode = false;
    var deleteRequested = false;

    async function init() {
        try {
            const fd = new FormData(); fd.append('action','verificarsesion'); fd.append('k',k);
            const r = await fetch(API_URL, {method:'POST', body:fd});
            const d = await r.json();
            if(d.status !== 'success') throw new Error();
            document.body.style.opacity = 1;
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            flatpickr("#filter-start", { defaultDate: firstDay, dateFormat: "Y-m-d", locale: "es", theme: "dark" });
            flatpickr("#filter-end", { defaultDate: today, dateFormat: "Y-m-d", locale: "es", theme: "dark" });
            flatpickr("#modal-fecha", { defaultDate: today, dateFormat: "Y-m-d", locale: "es", theme: "dark" });
            cargarDatos();
        } catch(e) { window.location.replace('index.html'); }
    }

    function cargarDatos() {
       const start = document.getElementById('filter-start').value;
       const end = document.getElementById('filter-end').value;
       document.getElementById('tree-root').innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-sec)">Actualizando...</div>';
       
       fetch(`${API_URL}?action=getfinancetree&k=${k}&start=${start}&end=${end}`)
       .then(r => r.json())
       .then(data => {
           globalData = data;
           currentSummary = data.summary;
           updateDashboardValues(currentSummary.ingresos, currentSummary.gastos, currentSummary.total, false);
           renderTree(data.tree);
           setupDatalists(data.options);
           setTreeView('L1');
       })
       .catch(e => {
           document.getElementById('tree-root').innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">Error de conexi√≥n.</div>';
       });
    }

    function renderTree(tree) {
       let html = '';
       if (Object.keys(tree).length === 0) { document.getElementById('tree-root').innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-sec)">Sin registros.</div>'; return; }
       
       for (let l1 in tree) {
         const l1TotalStr = formatMoney(tree[l1].total);
         html += `<details class="l1-details">
           <summary><div style="display:flex; align-items:center;"><input type="checkbox" class="parent-check" onchange="toggleChildren(this)"><span class="l1-name">${l1}</span></div><span data-original="${l1TotalStr}" style="font-family:'Outfit', monospace; font-weight:700; color:#FFD700">${l1TotalStr}</span></summary>`;
         
         for (let l2 in tree[l1].subs) {
           let sub = tree[l1].subs[l2];
           const l2TotalStr = formatMoney(sub.total);
           html += `<div class="l2-container"><details class="l2-details"> <summary><div style="display:flex; align-items:center;"><input type="checkbox" class="parent-check" onchange="toggleChildren(this)"><span class="l2-name">${l2}</span></div><span data-original="${l2TotalStr}" style="font-size:0.9em; opacity:0.9; font-family:'Outfit', monospace">${l2TotalStr}</span></summary><div class="table-responsive"><table>`;
           
           sub.items.forEach(item => {
             // Escapamos comillas para evitar errores en el HTML inline
             let safeDet = item.detalle.replace(/"/g, '&quot;');
             html += `<tr ondblclick="openModal('edit', '${item.id}', '${item.fecha}', '${l1}', '${l2}', '${safeDet}', '${item.monto}')">
               <td width="30" style="text-align:center"><input type="checkbox" class="item-check" value="${item.monto}" onchange="calcSelection()"></td>
               <td width="70" style="color:#000; font-weight:600">${item.fecha}</td>
               <td class="col-desc">${item.detalle}</td>
               <td class="col-monto ${item.monto < 0 ? 'neg' : 'pos'}">${formatMoney(item.monto)}</td>
             </tr>`;
           });
           
           html += `</table></div></details></div>`;
         } 
         html += `</details>`;
       } 
       document.getElementById('tree-root').innerHTML = html;
    }

    // --- MODAL Y EDICI√ìN ---
    function openModal(mode, id, fecha, l1, l2, det, monto) {
        const m = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const btn = document.getElementById('btn-main');
        const pinArea = document.getElementById('pin-area');
        
        pinArea.style.display = 'none';
        deleteRequested = false;

        if (mode === 'create') {
            currentEditMode = false;
            document.body.classList.remove('edit-mode');
            document.getElementById('expenseForm').reset();
            title.innerText = "Nueva Transacci√≥n";
            btn.innerText = "GUARDAR";
            document.getElementById('btn-del').style.display = 'none';
            document.querySelector('.modal-content').style.borderColor = 'var(--glass-border)';
            flatpickr("#modal-fecha", { defaultDate: new Date(), dateFormat: "Y-m-d", locale: "es", theme: "dark" });
        } else {
            // MODO EDICI√ìN SOMBRA
            currentEditMode = true;
            document.body.classList.add('edit-mode');
            
            document.getElementById('edit-id').value = id;
            document.getElementById('orig-amount').value = monto;
            
            // Re-convertir fecha para el datepicker si viene como DD/MM/YYYY
            let dateObj = new Date();
            if(fecha && fecha.includes('/')) {
                const parts = fecha.split('/');
                dateObj = new Date(parts[2], parts[1]-1, parts[0]);
            }
            flatpickr("#modal-fecha", { defaultDate: dateObj, dateFormat: "Y-m-d", locale: "es", theme: "dark" });
            
            document.getElementById('input_l1').value = l1;
            updateDatalistL2();
            document.getElementById('input_l2').value = l2;
            document.getElementById('l3').value = det;
            document.getElementById('monto').value = monto;
            
            title.innerText = "Modificar Registro #" + id.substr(0,4);
            btn.innerText = "SOLICITAR CAMBIO üîí";
            document.getElementById('btn-del').style.display = 'block';
            document.querySelector('.modal-content').style.borderColor = 'var(--accent-edit)';
        }
        m.style.display = 'flex';
    }

    function checkDiff() {
        if(!currentEditMode) return;
        const oldVal = parseFloat(document.getElementById('orig-amount').value);
        const newVal = parseFloat(document.getElementById('monto').value);
        const diff = document.getElementById('audit-msg');
        
        if(!isNaN(newVal) && newVal !== oldVal) {
            let d = newVal - oldVal;
            diff.style.display = 'block';
            diff.innerText = `Diferencia: ${d > 0 ? '+' : ''}${formatMoney(d)}`;
            diff.style.color = d > 0 ? 'var(--success)' : 'var(--danger)';
        } else {
            diff.style.display = 'none';
        }
    }

    function handleMainAction() {
        if (!currentEditMode) {
            enviarDatos();
        } else {
            document.getElementById('pin-area').style.display = 'block';
            document.getElementById('btn-main').style.display = 'none';
            document.getElementById('btn-del').style.display = 'none';
            deleteRequested = false;
        }
    }

    function reqDelete() {
        document.getElementById('pin-area').style.display = 'block';
        document.getElementById('btn-main').style.display = 'none';
        document.getElementById('btn-del').style.display = 'none';
        deleteRequested = true;
        document.querySelector('#pin-area label').innerText = "üîí PIN PARA ELIMINAR";
        document.querySelector('#pin-area button').innerText = "CONFIRMAR BORRADO";
        document.querySelector('#pin-area button').style.background = "var(--danger)";
    }

    function enviarDatos() {
        const btn = document.getElementById('btn-main');
        btn.innerText = "Guardando...";
        btn.disabled = true;
        
        const payload = { 
            fecha: document.getElementById('modal-fecha').value, 
            nivel1: document.getElementById('input_l1').value, 
            nivel2: document.getElementById('input_l2').value, 
            nivel3: document.getElementById('l3').value, 
            monto: document.getElementById('monto').value 
        };
        
        const fd = new FormData(); 
        fd.append('action', 'saveexpense'); 
        fd.append('k', k); 
        fd.append('data', JSON.stringify(payload)); 
        
        fetch(API_URL, { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => { 
             if(d.status === 'success') {
                closeModal(); 
                cargarDatos(); 
             } else { alert("Error: " + JSON.stringify(d)); }
             btn.innerText = "GUARDAR";
             btn.disabled = false;
        });
    }

    function confirmEdit() {
        const pin = document.getElementById('auth-pin').value;
        const id = document.getElementById('edit-id').value;
        const type = deleteRequested ? 'DELETE' : 'UPDATE';
        
        const payload = { 
            fecha: document.getElementById('modal-fecha').value, 
            nivel1: document.getElementById('input_l1').value, 
            nivel2: document.getElementById('input_l2').value, 
            nivel3: document.getElementById('l3').value, 
            monto: document.getElementById('monto').value 
        };

        const fd = new FormData();
        fd.append('action', 'modify');
        fd.append('k', k);
        fd.append('type', type);
        fd.append('id', id);
        fd.append('pin', pin);
        fd.append('data', JSON.stringify(payload));

        fetch(API_URL, { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => {
            if(d.status === 'success') {
                alert(deleteRequested ? "Registro eliminado" : "Registro actualizado");
                closeModal();
                cargarDatos();
            } else {
                alert("ERROR: " + d.message);
                document.getElementById('auth-pin').value = '';
            }
        });
    }

    function openPinModal() { document.getElementById('pinModal').style.display = 'flex'; }
    function submitPinChange() {
        const oldP = document.getElementById('old-pin').value;
        const newP = document.getElementById('new-pin').value;
        if(newP.length < 4) { alert("El nuevo PIN debe tener 4 d√≠gitos"); return; }
        
        const fd = new FormData();
        fd.append('action', 'changepin');
        fd.append('k', k);
        fd.append('oldPin', oldP);
        fd.append('newPin', newP);
        
        fetch(API_URL, { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => {
            if(d.status === 'success') { alert("¬°PIN Maestro Actualizado!"); document.getElementById('pinModal').style.display='none'; }
            else { alert("Error: " + d.message); }
        });
    }

    function closeModal() { 
        document.getElementById('modal').style.display = 'none'; 
        document.getElementById('btn-main').style.display = 'block';
        document.body.classList.remove('edit-mode');
        // Reset textos PIN
        document.querySelector('#pin-area label').innerText = "üîí PIN DE AUTORIZACI√ìN";
        document.querySelector('#pin-area button').innerText = "CONFIRMAR CAMBIO";
        document.querySelector('#pin-area button').style.background = "var(--accent-edit)";
        document.getElementById('auth-pin').value = '';
        document.getElementById('audit-msg').style.display = 'none';
    }

    function setTreeView(mode) {
        document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
        if(mode === 'L1') document.querySelectorAll('.btn-view')[0].classList.add('active');
        if(mode === 'L2') document.querySelectorAll('.btn-view')[1].classList.add('active');
        if(mode === 'ALL') document.querySelectorAll('.btn-view')[2].classList.add('active');
        const l1Details = document.querySelectorAll('.l1-details');
        const l2Details = document.querySelectorAll('.l2-details');
        if (mode === 'L1') { l1Details.forEach(d => d.removeAttribute('open')); l2Details.forEach(d => d.removeAttribute('open')); } 
        else if (mode === 'L2') { l1Details.forEach(d => d.setAttribute('open', '')); l2Details.forEach(d => d.removeAttribute('open')); } 
        else if (mode === 'ALL') { l1Details.forEach(d => d.setAttribute('open', '')); l2Details.forEach(d => d.setAttribute('open', '')); }
    }

    function updateDashboardValues(ingresos, gastos, total, isSelectionMode) {
       document.getElementById('dash-in').innerText = formatMoney(ingresos);
       document.getElementById('dash-out').innerText = formatMoney(gastos);
       document.getElementById('dash-total').innerText = formatMoney(total);
       document.getElementById('dash-total').style.color = total >= 0 ? 'var(--success)' : 'var(--danger)';
       const cards = document.querySelectorAll('.card');
       if (isSelectionMode) { cards.forEach(c => c.classList.add('active-selection')); document.getElementById('lbl-in').innerText = "INGRESOS (SEL)"; document.getElementById('lbl-out').innerText = "GASTOS (SEL)"; document.getElementById('lbl-total').innerText = "BALANCE (SEL)"; } 
       else { cards.forEach(c => c.classList.remove('active-selection')); document.getElementById('lbl-in').innerText = "INGRESOS"; document.getElementById('lbl-out').innerText = "GASTOS"; document.getElementById('lbl-total').innerText = "BALANCE"; }
    }

    function calcSelection() {
       const checks = document.querySelectorAll('.item-check:checked');
       if (checks.length === 0) { 
           updateDashboardValues(currentSummary.ingresos, currentSummary.gastos, currentSummary.total, false);
           document.querySelectorAll('.l1-details').forEach(l1 => {
               const origL1 = l1.querySelector('summary > span:last-child').getAttribute('data-original');
               if(origL1) l1.querySelector('summary > span:last-child').innerText = origL1;
               l1.querySelectorAll('.l2-details').forEach(l2 => {
                   const origL2 = l2.querySelector('summary > span:last-child').getAttribute('data-original');
                   if(origL2) l2.querySelector('summary > span:last-child').innerText = origL2;
               });
           });
           return; 
       }
       let selIngresos = 0, selGastos = 0;
       checks.forEach(c => { let val = parseFloat(c.value); if (val >= 0) selIngresos += val; else selGastos += val; });
       updateDashboardValues(selIngresos, selGastos, selIngresos + selGastos, true);
       document.querySelectorAll('.l1-details').forEach(l1 => {
           let l1Total = 0;
           l1.querySelectorAll('.l2-details').forEach(l2 => {
               let l2Total = 0;
               l2.querySelectorAll('.item-check:checked').forEach(chk => { l2Total += parseFloat(chk.value); });
               l2.querySelector('summary > span:last-child').innerText = formatMoney(l2Total);
               l1Total += l2Total;
           });
           l1.querySelector('summary > span:last-child').innerText = formatMoney(l1Total);
       });
    }

    function toggleChildren(source) {
       const parent = source.closest('details');
       const children = parent.querySelectorAll('input[type="checkbox"]');
       children.forEach(c => { if (c !== source) c.checked = source.checked; });
       calcSelection(); 
    }

    function setupDatalists(options) { const dl1 = document.getElementById('list_l1'); dl1.innerHTML = ''; for(let key in options) { let op = document.createElement('option'); op.value = key; dl1.appendChild(op); } }
    function updateDatalistL2() { const val1 = document.getElementById('input_l1').value; const dl2 = document.getElementById('list_l2'); dl2.innerHTML = ''; document.getElementById('input_l2').value = ''; if(globalData.options && globalData.options[val1]) { globalData.options[val1].forEach(sub => { let op = document.createElement('option'); op.value = sub; dl2.appendChild(op); }); } }
    
    function formatMoney(n) { return '$ ' + parseFloat(n).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }
    
    function toggleExportMenu() { const menu = document.getElementById('export-menu'); if (menu.style.display === 'block') menu.style.display = 'none'; else menu.style.display = 'block'; }
    window.onclick = function(event) { if (!event.target.matches('.btn-export')) { const menu = document.getElementById('export-menu'); if (menu && menu.style.display === 'block') { menu.style.display = 'none'; } } }
    document.getElementById('btnVolver').onclick = () => window.location.replace(`inicio.html?k=${k}`);

    // PDF EXPORT (Mismo c√≥digo que antes)
    function exportarPDF(modo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const domL1 = document.querySelectorAll('.l1-details');
        let exportGroups = []; let totalIng = 0; let totalGas = 0;
        domL1.forEach(l1Node => {
            const l1Name = l1Node.querySelector('.l1-name').innerText.trim();
            const l2Nodes = l1Node.querySelectorAll('.l2-details');
            let l1Group = { name: l1Name, total: 0, subs: [], items: [] };
            let l1HasSelection = false;
            l2Nodes.forEach(l2Node => {
                const l2Name = l2Node.querySelector('.l2-name').innerText.trim();
                const checkedItems = l2Node.querySelectorAll('.item-check:checked');
                let l2Group = { name: l2Name, total: 0, items: [] };
                checkedItems.forEach(chk => {
                    const val = parseFloat(chk.value);
                    const row = chk.closest('tr');
                    const cols = row.querySelectorAll('td');
                    const fecha = cols[1].innerText.trim();
                    const detalle = cols[2].innerText.trim();
                    l2Group.total += val;
                    l2Group.items.push({ fecha, detalle, monto: val });
                    l1Group.total += val;
                    if(val >= 0) totalIng += val; else totalGas += val;
                    l1Group.items.push({ fecha, detalle, monto: val });
                });
                if (l2Group.items.length > 0) { l1Group.subs.push(l2Group); l1HasSelection = true; }
            });
            if (l1HasSelection) { exportGroups.push(l1Group); }
        });
        if (exportGroups.length === 0) { alert("Selecciona √≠tems para exportar."); return; }
        let bodyFinal = [];
        exportGroups.forEach(group => {
            bodyFinal.push([{ content: group.name.toUpperCase() + "   (" + formatMoney(group.total) + ")", colSpan: 3, styles: { fillColor: [33, 33, 33], textColor: [255, 215, 0], fontStyle: 'bold', halign: 'left', cellPadding: 4, lineWidth: { bottom: 1 }, lineColor: [50, 50, 50] } }]);
            if (modo === 'jerarquico') {
                group.subs.forEach(sub => {
                    bodyFinal.push([{ content: "      >> " + sub.name + "   (" + formatMoney(sub.total) + ")", colSpan: 3, styles: { fillColor: [240, 240, 240], textColor: [50, 50, 50], fontStyle: 'bold', halign: 'left', cellPadding: 2, fontSize: 9 } }]);
                    sub.items.forEach(item => addItemRow(item));
                });
            } else { group.items.forEach(item => addItemRow(item)); }
        });
        function addItemRow(item) {
            bodyFinal.push([ item.fecha, item.detalle, { content: formatMoney(item.monto), styles: { textColor: item.monto < 0 ? [220, 53, 69] : [0, 80, 0], halign: 'right', fontStyle: 'bold' } } ]);
        }
        doc.setFontSize(14); doc.setTextColor(40);
        const titulo = modo === 'jerarquico' ? "Reporte Jer√°rquico" : "Reporte Simplificado";
        doc.text(titulo, 14, 15);
        doc.setFontSize(8); doc.setTextColor(100);
        const fechaGen = new Date().toLocaleDateString();
        doc.text(`Generado: ${fechaGen}`, 14, 20);
        const balance = totalIng + totalGas;
        doc.autoTable({ startY: 22, head: [['INGRESOS', 'GASTOS', 'BALANCE']], body: [[formatMoney(totalIng), formatMoney(totalGas), formatMoney(balance)]], theme: 'grid', headStyles: { fillColor: [33, 33, 33], textColor: 255, halign: 'center', fontSize: 9 }, bodyStyles: { halign: 'center', fontSize: 9, fontStyle: 'bold' }, columnStyles: { 0: { textColor: [0, 80, 0] }, 1: { textColor: [220, 53, 69] }, 2: { textColor: balance >= 0 ? [0, 80, 0] : [220, 53, 69] } }, tableWidth: 'wrap', margin: { left: 14 } });
        doc.autoTable({ startY: doc.lastAutoTable.finalY + 6, head: [['FECHA', 'DETALLE', 'MONTO']], body: bodyFinal, theme: 'plain', styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak', lineColor: [220, 220, 220], lineWidth: 0.1 }, headStyles: { fillColor: [59, 130, 246], textColor: 255, fontStyle: 'bold' }, columnStyles: { 0: { cellWidth: 22 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 32 } }, margin: { left: 14, right: 14 } });
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(7); doc.setTextColor(150); doc.text('Control Finanzas Pro', 14, doc.internal.pageSize.height - 10); doc.text(`P√°g ${i}/${pageCount}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10); }
        doc.save(`Reporte_${modo}_${fechaGen.replace(/\//g,'-')}.pdf`);
    }
    
    window.onload = init;
  </script>
</body>
</html>